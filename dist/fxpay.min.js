!function(a,b){"use strict";"function"==typeof define?define(b):"object"==typeof exports?module.exports=b():a.fxpay=b()}(this,function(){var a,b,c;return function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.slice(0,n.length-1).concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){var c=v.call(arguments,0);return"string"!=typeof c[0]&&1===c.length&&c.push(null),n.apply(d,c.concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){if("string"==typeof a)return p[a]?p[a](b):j(o(a,b).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n},n.config=function(a){return n(a)},a._defined=q,c=function(a,b,c){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("api",["exports","errors","settings"],function(a,b,c){"use strict";function d(a,b){b=b||{},this.baseUrl=a,this.log=c.log,this.timeoutMs=c.apiTimeoutMs||1e4,this.versionPrefix=c.apiVersionPrefix||void 0}function e(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}d.prototype.url=function(a,b){b=b||{},b.versioned="undefined"!=typeof b.versioned?b.versioned:!0;var c=this.baseUrl;return b.versioned&&(c+=this.versionPrefix||""),c+=a},d.prototype.request=function(a,d,f,g,h){h=h||{};var i=f?"application/x-www-form-urlencoded":null;h.contentType=h.contentType||i;var j={Accept:"application/json"};h.contentType&&(j["Content-Type"]=h.contentType),h.headers=h.headers||{};for(var k in j)k in h.headers||(h.headers[k]=j[k]);h.headers["x-fxpay-version"]=c.libVersion;var l,m=this.log,n=this;g||(g=function(a,b){if(a)throw a;m.info("default callback received data:",b)}),l=/^http(s)?:\/\/.*/.test(d)?d:this.url(d);var o=new XMLHttpRequest,p={abort:function(){g(b.ApiRequestAborted("XHR request aborted for path: "+d))},error:function(a){m.debug("XHR error event:",a),g(b.ApiRequestError("received XHR error for path: "+d))},load:function(){var a;if("2"!==this.status.toString().slice(0,1)){var c=b.BadApiResponse("Unexpected status: "+this.status+" for URL: "+l);return m.debug(c.toString(),"response:",this.responseText),g(c)}m.debug("XHR load: GOT response:",this.responseText);try{a=JSON.parse(this.responseText)}catch(d){var c=b.BadJsonResponse("Unparsable JSON for URL: "+l+"; exception: "+d);return m.debug(c.toString(),"response:",this.responseText),g(c)}g(null,a)},timeout:function(){g(b.ApiRequestTimeout("XHR request to "+l+" timed out after "+n.timeoutMs+"ms"))}};for(var q in p)o.addEventListener(q,p[q],!1);m.debug("opening",a,"to",l),o.open(a,l,!0),o.timeout=n.timeoutMs;for(var r in h.headers)o.setRequestHeader(r,h.headers[r]);"application/x-www-form-urlencoded"===h.contentType&&f&&(f=e(f)),o.send(f)},d.prototype.get=function(a,b,c){this.request("GET",a,null,b,c)},d.prototype.del=function(a,b,c){this.request("DELETE",a,null,b,c)},d.prototype.post=function(a,b,c,d){this.request("POST",a,b,c,d)},d.prototype.put=function(a,b,c,d){this.request("PUT",a,b,c,d)},a.API=d}),function(){"use strict";function a(a){return"function"==typeof a||"object"==typeof a&&null!==a}function b(a){return"function"==typeof a}function d(a){return"object"==typeof a&&null!==a}function e(){}function f(){return function(){process.nextTick(j)}}function g(){var a=0,b=new M(j),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function h(){var a=new MessageChannel;return a.port1.onmessage=j,function(){a.port2.postMessage(0)}}function i(){return function(){setTimeout(j,1)}}function j(){for(var a=0;J>a;a+=2){var b=O[a],c=O[a+1];b(c),O[a]=void 0,O[a+1]=void 0}J=0}function k(){}function l(){return new TypeError("You cannot resolve a promise with itself")}function m(){return new TypeError("A promises callback cannot return that same promise.")}function n(a){try{return a.then}catch(b){return S.error=b,S}}function o(a,b,c,d){try{a.call(b,c,d)}catch(e){return e}}function p(a,b,c){K(function(a){var d=!1,e=o(c,b,function(c){d||(d=!0,b!==c?s(a,c):u(a,c))},function(b){d||(d=!0,v(a,b))},"Settle: "+(a._label||" unknown promise"));!d&&e&&(d=!0,v(a,e))},a)}function q(a,b){b._state===Q?u(a,b._result):a._state===R?v(a,b._result):w(b,void 0,function(b){s(a,b)},function(b){v(a,b)})}function r(a,c){if(c.constructor===a.constructor)q(a,c);else{var d=n(c);d===S?v(a,S.error):void 0===d?u(a,c):b(d)?p(a,c,d):u(a,c)}}function s(b,c){b===c?v(b,l()):a(c)?r(b,c):u(b,c)}function t(a){a._onerror&&a._onerror(a._result),x(a)}function u(a,b){a._state===P&&(a._result=b,a._state=Q,0===a._subscribers.length||K(x,a))}function v(a,b){a._state===P&&(a._state=R,a._result=b,K(t,a))}function w(a,b,c,d){var e=a._subscribers,f=e.length;a._onerror=null,e[f]=b,e[f+Q]=c,e[f+R]=d,0===f&&a._state&&K(x,a)}function x(a){var b=a._subscribers,c=a._state;if(0!==b.length){for(var d,e,f=a._result,g=0;g<b.length;g+=3)d=b[g],e=b[g+c],d?A(c,d,e,f):e(f);a._subscribers.length=0}}function y(){this.error=null}function z(a,b){try{return a(b)}catch(c){return T.error=c,T}}function A(a,c,d,e){var f,g,h,i,j=b(d);if(j){if(f=z(d,e),f===T?(i=!0,g=f.error,f=null):h=!0,c===f)return void v(c,m())}else f=e,h=!0;c._state!==P||(j&&h?s(c,f):i?v(c,g):a===Q?u(c,f):a===R&&v(c,f))}function B(a,b){try{b(function(b){s(a,b)},function(b){v(a,b)})}catch(c){v(a,c)}}function C(a,b,c,d){this._instanceConstructor=a,this.promise=new a(k,d),this._abortOnReject=c,this._validateInput(b)?(this._input=b,this.length=b.length,this._remaining=b.length,this._init(),0===this.length?u(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&u(this.promise,this._result))):v(this.promise,this._validationError())}function D(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function E(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function F(a){this._id=Z++,this._state=void 0,this._result=void 0,this._subscribers=[],k!==a&&(b(a)||D(),this instanceof F||E(),B(this,a))}var G;G=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};var H,I=G,J=(Date.now||function(){return(new Date).getTime()},Object.create||function(a){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof a)throw new TypeError("Argument must be an object");return e.prototype=a,new e},0),K=function(a,b){O[J]=a,O[J+1]=b,J+=2,2===J&&H()},L="undefined"!=typeof window?window:{},M=L.MutationObserver||L.WebKitMutationObserver,N="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,O=new Array(1e3);H="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?f():M?g():N?h():i();var P=void 0,Q=1,R=2,S=new y,T=new y;C.prototype._validateInput=function(a){return I(a)},C.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},C.prototype._init=function(){this._result=new Array(this.length)};var U=C;C.prototype._enumerate=function(){for(var a=this.length,b=this.promise,c=this._input,d=0;b._state===P&&a>d;d++)this._eachEntry(c[d],d)},C.prototype._eachEntry=function(a,b){var c=this._instanceConstructor;d(a)?a.constructor===c&&a._state!==P?(a._onerror=null,this._settledAt(a._state,b,a._result)):this._willSettleAt(c.resolve(a),b):(this._remaining--,this._result[b]=this._makeResult(Q,b,a))},C.prototype._settledAt=function(a,b,c){var d=this.promise;d._state===P&&(this._remaining--,this._abortOnReject&&a===R?v(d,c):this._result[b]=this._makeResult(a,b,c)),0===this._remaining&&u(d,this._result)},C.prototype._makeResult=function(a,b,c){return c},C.prototype._willSettleAt=function(a,b){var c=this;w(a,void 0,function(a){c._settledAt(Q,b,a)},function(a){c._settledAt(R,b,a)})};var V=function(a,b){return new U(this,a,!0,b).promise},W=function(a,b){function c(a){s(f,a)}function d(a){v(f,a)}var e=this,f=new e(k,b);if(!I(a))return v(f,new TypeError("You must pass an array to race.")),f;for(var g=a.length,h=0;f._state===P&&g>h;h++)w(e.resolve(a[h]),void 0,c,d);return f},X=function(a,b){var c=this;if(a&&"object"==typeof a&&a.constructor===c)return a;var d=new c(k,b);return s(d,a),d},Y=function(a,b){var c=this,d=new c(k,b);return v(d,a),d},Z=0,$=F;F.all=V,F.race=W,F.resolve=X,F.reject=Y,F.prototype={constructor:F,then:function(a,b){var c=this,d=c._state;if(d===Q&&!a||d===R&&!b)return this;var e=new this.constructor(k),f=c._result;if(d){var g=arguments[d-1];K(function(){A(d,e,g,f)})}else w(c,e,a,b);return e},"catch":function(a){return this.then(null,a)}};var _=function(){var a;a="undefined"!=typeof global?global:"undefined"!=typeof window&&window.document?window:self;var c="Promise"in a&&"resolve"in a.Promise&&"reject"in a.Promise&&"all"in a.Promise&&"race"in a.Promise&&function(){var c;return new a.Promise(function(a){c=a}),b(c)}();c||(a.Promise=$)},ab={Promise:$,polyfill:_};"function"==typeof c&&c.amd?c("promise",[],function(){return ab}):"undefined"!=typeof module&&module.exports?module.exports=ab:"undefined"!=typeof this&&(this.ES6Promise=ab)}.call(this),c("utils",["exports","errors","settings"],function(a,b,c){"use strict";a.defaults=function(a,b){return a=a||{},Object.keys(b).forEach(function(c){"undefined"==typeof a[c]&&(a[c]=b[c])}),a},a.getSelfOrigin=function(a){if(a=a||c,a.appSelf)return a.appSelf.origin;var b=a.window;return b.location.origin?b.location.origin:b.location.protocol+"//"+b.location.hostname},a.getUrlOrigin=function(a){var b=document.createElement("a");return b.href=a,b.origin||b.protocol+"//"+b.host},a.getCenteredCoordinates=function(a,b){var c=window.screenX+Math.max(0,Math.floor((window.innerWidth-a)/2)),d=window.screenY+Math.max(0,Math.floor((window.innerHeight-b)/2));return[c,d]},a.reCenterWindow=function(b,d,e){d=d||c.winWidth,e=e||c.winHeight;var f=a.getCenteredCoordinates(d,e);try{d+=b.outerWidth-b.innerWidth,e+=b.outerHeight-b.innerHeight,c.log.log("width: ",d,"height:",e),b.resizeTo(d,e),b.moveTo(f[0],f[1])}catch(g){c.log.log("We don't have permission to resize this window")}},a.openWindow=function(b){var d={url:"",title:"FxPay",w:c.winWidth,h:c.winHeight};b=a.defaults(b,d);var e=a.getCenteredCoordinates(b.w,b.h),f="toolbar=no,location=yes,directories=no,menubar=no,scrollbars=yes,resizable=no,copyhistory=no,width="+b.w+",height="+b.h+",top="+e[1]+",left="+e[0],g=c.window.open(b.url,b.title,f);return g||c.log.error("window.open() failed. URL:",b.url),g},a.getAppSelf=function(a){function d(a){if(null===a)throw new Error("cannot store a null appSelf");return c.appSelf=a,a}if(null!==c.appSelf)return a(null,c.appSelf);if(!c.mozApps)return c.log.info("web platform does not define mozApps, cannot get appSelf"),a(null,d(!1));var e=c.mozApps.getSelf();e.onsuccess=function(){var b=this.result;c.log.info("got appSelf from mozApps.getSelf()"),a(null,d(b||!1))},e.onerror=function(){var d=this.error.name;c.log.error("mozApps.getSelf() returned an error",d),a(b.InvalidApp("invalid application: "+d,{code:d}),c.appSelf)}},a.logDeprecation=function(a,b){c.log.warn(a+". This was deprecated in "+b+". More info: https://github.com/mozilla/fxpay/releases/tag/"+b)}}),c("receipts",["exports","api","errors","products","settings","utils"],function(a,b,c,d,e,f){"use strict";function g(a,b){var d=e.appSelf.addReceipt(a);d.onsuccess=function(){e.log.info("item fully purchased and receipt installed"),b(null)},d.onerror=function(){var a=this.error.name;b(c.AddReceiptError("error calling app.addReceipt: "+a,{code:a}))}}function h(a,b){var c=e.localStorage.getItem(e.localStorageKey);c=c?JSON.parse(c):[],-1===c.indexOf(a)?c.push(a):e.log.info("not adding receipt",a.substring(0,5),"because it has already been added"),e.localStorage.setItem(e.localStorageKey,JSON.stringify(c)),b(null)}function i(a,b){var d=m(a);return d?void b(null,d):b(new c.InvalidReceipt("invalid JWT data"),{})}function j(b,d,f,g){e.log.debug("receipt data:",d);var h=o(d);e.log.info("about to post to verifier URL",d.verify),h.post(d.verify,b,function(d,h){return f.receiptInfo=a.ReceiptInfo(b,h),d?(e.log.error("Error verifying receipt:",d.toString()),g(d,f)):(e.log.info("verification result:",h),"ok"===h.status?(e.log.info("validated receipt for",f),g(null,f)):g(c.InvalidReceipt("receipt "+b.substring(0,50)+" is invalid; service returned: "+h.status+" "+h.reason),f))},{contentType:"text/plain"})}function k(a,b,d){if(!a.product)return d(c.InvalidReceipt("receipt is missing the product field"),b);if(!a.product.url)return d(c.InvalidReceipt("receipt is missing product.url"),b);if(!a.product.storedata)return d(c.InvalidReceipt("receipt is missing product.storedata"),b);if(a.product.storedataObject=n(a),!a.product.storedataObject)return d(c.InvalidReceipt("missing storedata"),b);var g="test-receipt"===a.typ;if(g&&!e.allowTestReceipts)return d(c.TestReceiptNotAllowed("cannot restore test receipts when allowTestReceipts is false"),b);var h=a.product.url;if(h&&!h.match(/^(http(s)?|app):\/\/.*$/g)&&(h="app://"+h),b.productUrl=h,!g){var i=f.getSelfOrigin();if(h!==i)return d(c.InvalidReceipt("app origin "+i+" does not match receipt product URL "+h),b)}d(null,b)}function l(a,b){for(var d=!1,f=a.verify||"",g=0;g<e.receiptCheckSites.length;g++){var h=e.receiptCheckSites[g];if(0===f.indexOf(h)){d=!0;break}}return d?void b(null,a):b(c.InvalidReceipt("Receipt check URL "+a.verify+" is not whitelisted. Valid choices: "+e.receiptCheckSites),a)}function m(a){var b;if("string"!=typeof a)return e.log.error("unexpected receipt type:",typeof a),null;var c=a.split("~");if(1===c.length)b=c[0];else{if(2!==c.length)return e.log.error("wrong number of tilde separated segments in receipt"),null;b=c[1]}var d=b.split(".");if(3!==d.length)return e.log.error("wrong number of JWT segments in receipt:",d.length),null;b=d[1];try{b=p(b)}catch(f){return e.log.error("error base64 decoding receipt:",f.name,f.message),null}try{b=JSON.parse(b)}catch(f){return e.log.error("error parsing receipt JSON:",f.name,f.message),null}return b}function n(a){if(!a.product)return null;if("string"!=typeof a.product.storedata)return e.log.error("unexpected storedata in receipt:",a.product.storedata),null;var b={};return a.product.storedata.split("&").forEach(function(a){var c=a.split("=");b[c[0]]=decodeURIComponent(c[1])}),b}function o(a){var c=a.iss;return e.log.info("derived base API URL from receipt:",c),new b.API(c)}function p(a){switch(a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),a.length%4){case 0:break;case 1:a+="===";break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}return atob(a)}function q(a,b){if(b=b||{},!(this instanceof q)){var c=Object.create(q.prototype);return q.apply(c,arguments)}return this.receipt=a,this.status=b.status,this.reason=b.reason,this}a.all=function(a){f.getAppSelf(function(b,c){if(b)return a(b);var d=0,f=[];c&&c.receipts&&(d=c.receipts.length,f=Array.prototype.slice.call(c.receipts));var g=0,h=e.localStorage.getItem(e.localStorageKey);if(h){h=JSON.parse(h);for(var i=0;i<h.length;i++)-1===f.indexOf(h[i])?(f.push(h[i]),g++):e.log.info("ignoring dupe receipt fetched from local storage",h[i].substring(0,5))}e.log.info("receipts fetched from mozApps:",d),e.log.info("receipts fetched from localStorage:",g),a(null,f)})},a.add=function(a,b){f.getAppSelf(function(d,f){return d?b(d):f&&f.addReceipt?(e.log.info("adding receipt to device with addReceipt"),g(a,b)):e.localStorage?(e.log.info("adding receipt to device with localStorage"),h(a,b)):b(c.PayPlatformUnavailable("no storage mechanism for adding receipts"))})},a.validateAppReceipt=function(b,d){a.verifyAppData(b,function(a,e,g){return a?d(a,g):void j(b,e,g,function(a,b){if(a)return d(a,b);var e=f.getSelfOrigin();return b.productUrl!==e?d(c.InvalidReceipt("valid receipt but wrong product; our origin: "+e+"; receipt product origin: "+b.productUrl),b):void d(null,b)})})},a.validateInAppProductReceipt=function(b,c,d){a.verifyInAppProductData(b,c,function(a,c,e){return a?d(a,e):void j(b,c,e,function(a,b){d(a,b)})})},a.verifyData=function(a,b,c){i(a,function(a,d){return a?c(a,d,{}):void k(d,b,function(a,b){return a?c(a,d,b):void l(d,function(a){return a?c(a,d,b):void c(null,d,b)})})})},a.verifyAppData=function(b,g){var h=new d.Product;a.verifyData(b,h,function(a,b,d){return a?g(a,b,d):void f.getAppSelf(function(a,f){if(a)return g(a,b,d);if(!f)return g(c.PayPlatformUnavailable("mozApps.getSelf() is needed to verify receipts"),b,d);var h,i=f.manifest;return h=i.installs_allowed_from?-1!==i.installs_allowed_from.indexOf("*"):!0,h&&e.log.warn('your paid app manifest specifies installs_allowed_from = ["*"] which means an attacker can provide a spoofed receipt validation service'),h||-1!==i.installs_allowed_from.indexOf(b.iss)?(d.productId=b.product.storedataObject.id,d.productId?void g(null,b,d):g(c.InvalidReceipt("Could not find app productId in storedata:"+b.product.storedata),b,d)):g(c.InvalidReceipt("receipt issuer "+b.iss+" is not an allowed issuer; allowed: "+i.installs_allowed_from),b,d)})})},a.verifyInAppProductData=function(b,d,e){a.verifyData(b,d,function(a,b,d){return a?e(a,b,d):(d.productId=b.product.storedataObject.inapp_id,d.productId?void e(null,b,d):e(c.InvalidReceipt("Could not find in-app productId in storedata: "+b.product.storedata),b,d))})},a.checkStoreData=function(a){var b=m(a);return b?n(b):null},a.ReceiptInfo=q}),c("products",["exports","api","errors","promise","receipts","settings","utils"],function(a,b,c,d,e,f,g){"use strict";function h(a){a=a||{},this.pricePointId=a.pricePointId,this.productId=a.productId,this.name=a.name,this.smallImageUrl=a.smallImageUrl,this.receiptInfo=a.receiptInfo||{}}function i(){return new k(function(a,b){return f.productReceiptMap?a(f.productReceiptMap):(f.log.debug("building a product->receipt map"),void e.all(function(c,d){return c?b(c):(f.productReceiptMap={},d.forEach(function(a){var b=e.checkStoreData(a);return b?b.inapp_id?(f.log.debug("found receipt with inapp_id=",b.inapp_id),void(f.productReceiptMap[b.inapp_id]=a)):f.log.debug("ignoring receipt without inapp_id"):void f.log.debug("ignoring receipt with missing or unparsable storedata")}),void a(f.productReceiptMap))}))})}function j(a){return new h({pricePointId:a.price_id,productId:a.guid,name:a.name,smallImageUrl:a.logo_url})}var k=d.Promise;a.get=function(b,c){return i().then(function(){return new k(function(d,e){a.getById(b,function(a,c){return a?(f.log.error("no existing product with productId="+b+"; error: "+a),e(a)):void d(c)},c)})})},a.all=function(a){f.initialize();var d=i().then(function(){return new k(function(a,d){var e=[],h=new b.API(f.apiUrlBase),i=g.getSelfOrigin();if(!i)return d(c.InvalidApp("an origin is needed to get products"));i=encodeURIComponent(i);var k;f.fakeProducts?(f.log.warn("about to fetch fake products"),k="/payments/stub-in-app-products/"):(f.log.info("about to fetch real products for app",i),k="/payments/"+i+"/in-app/?active=1"),h.get(k,function(b,g){if(b)return d(b);if(!g||!g.objects)return f.log.debug("unexpected API response",g),d(c.BadApiResponse("received empty API response"));f.log.info("total products fetched:",g.objects.length);for(var h=0;h<g.objects.length;h++){var i=g.objects[h],k=j(i);e.push(k)}a(e)})})});return a&&(g.logDeprecation("getProducts(callback) is no longer supported; use the returned promise instead","0.0.15"),d.then(function(b){a(null,b)}).catch(function(b){a(b,[])})),d},a.getById=function(a,c,d){d=d||{},"undefined"==typeof d.fetchStubs&&(d.fetchStubs=!1),d.api||(d.api=new b.API(f.apiUrlBase));var e,h=encodeURIComponent(g.getSelfOrigin());e=d.fetchStubs?"/payments/stub-in-app-products/"+a.toString()+"/":"/payments/"+h+"/in-app/"+a.toString()+"/",f.log.info("fetching product info at URL",e,"fetching stubs?",d.fetchStubs),d.api.get(e,function(b,d){return b?(f.log.error("Error fetching product info",b.toString()),c(b,{productId:a})):void c(null,j(d))})},a.Product=h,h.prototype.getReceiptMap=function(){if(!f.productReceiptMap)throw c.IncorrectUsage("cannot proceed with this method; receipt map is empty");return f.productReceiptMap},h.prototype.hasReceipt=function(){return"undefined"!=typeof this.getReceiptMap()[this.productId]},h.prototype.validateReceipt=function(){var a=this.getReceiptMap(),b=this;return new k(function(d,g){var h=a[b.productId];return h?void e.validateInAppProductReceipt(h,b,function(a,b){return a?(f.log.error("receipt validation error: "+a),a.productInfo=b,g(a)):d(b)}):g(c.InvalidReceipt("could not find installed receipt for productId="+b.productId))})}}),c("adapter",["exports","api","errors","products","receipts","utils"],function(a,b,c,d,e,f){"use strict";function g(){}g.prototype.toString=function(){return"<FxInappAdapter at "+(this.api&&this.api.baseUrl)+">"},g.prototype.configure=function(a){this.settings=a,this.api=new b.API(a.apiUrlBase),a.log.info("configuring Firefox Marketplace In-App adapter")},g.prototype.startTransaction=function(a,b){a=f.defaults(a,{productId:null});var c=this.settings;this.api.post(c.prepareJwtApiUrl,{inapp:a.productId},function(d,e){return d?b(d):(c.log.debug("requested JWT for ",a.productId,"from API; got:",e),b(null,{productJWT:e.webpayJWT,productId:a.productId,productData:e}))})},g.prototype.transactionStatus=function(a,b){var d=this,e=d.api.url(a.productData.contribStatusURL,{versioned:!1});d.api.get(e,function(f,g){return f?b(f):"complete"!==g.status?"incomplete"===g.status?b(null,!1):b(c.ConfigurationError("transaction status "+g.status+" from "+e+" was unexpected")):void d._finishTransaction(g,a.productId,function(a,c){return a?b(a):void b(null,!0,c)})})},g.prototype._finishTransaction=function(a,b,c){var f=this.settings;f.log.info("received completed transaction:",a),e.add(a.receipt,function(a){return a?c(a):void d.getById(b,function(a,b){return a?c(a,b):void c(null,b)},{fetchStubs:f.fakeProducts})})},a.FxInappAdapter=g}),c("settings",["exports","adapter","errors"],function(a,b,c){"use strict";var d={version:"0.0.16"},e={allowTestReceipts:!1,apiUrlBase:"https://marketplace.firefox.com",apiVersionPrefix:"/api/v1",apiTimeoutMs:null,extraProviderUrls:null,fakeProducts:!1,log:window.console||{debug:function(){},error:function(){},info:function(){},log:function(){},warn:function(){}},receiptCheckSites:["https://receiptcheck.marketplace.firefox.com","https://marketplace.firefox.com"],adapter:null,appSelf:null,alreadyConfigured:!1,productReceiptMap:null,payProviderUrls:{"mozilla/payments/pay/v1":"https://marketplace.firefox.com/mozpay/?req={jwt}"},window:window,winWidth:276,winHeight:384,prepareJwtApiUrl:"/webpay/inapp/prepare/",onerror:function(a){throw a},oninit:function(){a.log.info("fxpay version:",a.libVersion),a.log.info("initialization ran successfully")},onrestore:function(b,c){b?a.log.error("error while restoring product:",c.productId,"message:",b):a.log.info("product",c.productId,"was restored from receipt")},localStorage:window.localStorage||null,localStorageKey:"fxpayReceipts",onBrokenWebRT:navigator.mozPay&&-1===navigator.userAgent.indexOf("Mobile"),mozPay:navigator.mozPay||null,mozApps:navigator.mozApps||null,libVersion:d.version};a.configure=function(d,f){if(f=f||{},a.alreadyConfigured||(f.reset=!0),f.reset)for(var g in e)a[g]=e[g];for(var h in d){if("undefined"==typeof a[h])return a.onerror(c.IncorrectUsage("configure() received an unknown setting: "+h));a[h]=d[h]}if(a.extraProviderUrls){a.log.info("adding extra pay provider URLs",a.extraProviderUrls);for(var i in a.extraProviderUrls)a.payProviderUrls[i]=a.extraProviderUrls[i]}a.fakeProducts&&(a.allowTestReceipts=!0);var j=b.FxInappAdapter;return a.adapter||(a.log.info("creating default adapter"),a.adapter=new j),a.adapter.configure(a),a.log.info("using adapter:",a.adapter.toString()),a.log.info("(re)configuration completed; fxpay version:",a.libVersion),a.alreadyConfigured=!0,a},a.initialize=function(b){"object"==typeof b&&b?a.configure(b):a.alreadyConfigured||a.configure()}}),c("errors",["exports","settings"],function(a,b){"use strict";function c(c,d){function e(a,c){if(c=c||{},!(this instanceof e)){var d=Object.create(e.prototype);return e.apply(d,arguments)}this.message=a,this.stack=(new Error).stack,c.code&&(this.code=c.code),this.productInfo=c.productInfo||{};var f=b.log||console;return f.error(this.toString()),this}d=d||{};var f=d.inherits||a.FxPayError||Error;return e.prototype=Object.create(f.prototype),e.prototype.name=c,d.code&&(e.prototype.code=d.code),e.prototype.toString=function(){var a=Error.prototype.toString.call(this);return this.code&&(a+=" {code: "+this.code+"}"),a},e}function d(b,d){b.forEach(function(b){var e=b[0],f=d||{};b[1]&&Object.keys(b[1]).forEach(function(a){f[a]=b[1][a]}),a[e]=c.call(this,e,f)})}a.createError=c,a.FxPayError=c("FxPayError"),d([["ConfigurationError"],["FailedWindowMessage"],["IncorrectUsage"],["InvalidApp"],["InvalidJwt"],["NotImplementedError"],["PayWindowClosedByUser",{code:"DIALOG_CLOSED_BY_USER"}],["UnknownMessageOrigin"]]),a.PaymentFailed=c("PaymentFailed"),d([["AppReceiptMissing"],["InvalidReceipt"],["PurchaseTimeout"],["TestReceiptNotAllowed"]],{inherits:a.PaymentFailed}),a.PlatformError=c("PlatformError"),d([["AddReceiptError"],["PayPlatformError"],["PayPlatformUnavailable"]],{inherits:a.PlatformError}),a.ApiError=c("ApiError"),d([["ApiRequestAborted"],["ApiRequestError"],["ApiRequestTimeout"],["BadApiResponse"],["BadJsonResponse"]],{inherits:a.ApiError})}),c("jwt",["exports","errors","settings"],function(a,b,c){"use strict";a.decode=function(a,d){var e=a.split(".");if(3!==e.length)return c.log.debug("JWT: not enough segments:",a),d(b.InvalidJwt("JWT does not have 3 segments"));var f=e[1];f=f.replace("-","+","g").replace("_","/","g");var g;try{g=atob(f)}catch(h){return d(b.InvalidJwt("atob() error: "+h.toString()+" when decoding JWT "+f))}var i;try{i=JSON.parse(g)}catch(h){return d(b.InvalidJwt("JSON.parse() error: "+h.toString()+" when parsing "+g))}d(null,i)},a.getPayUrl=function(d,e){a.decode(d,function(a,f){if(a)return e(a);var g=c.payProviderUrls[f.typ];return g?-1===g.indexOf("{jwt}")?e(b.ConfigurationError("JWT type "+f.typ+" pay URL is formatted incorrectly: "+g)):(g=g.replace("{jwt}",d),c.log.info("JWT",f.typ,"resulted in pay URL:",g),void e(null,g)):e(b.InvalidJwt("JWT type "+f.typ+" does not map to any known payment providers"))})}}),c("pay",["exports","errors","jwt","settings","utils"],function(a,b,c,d,e){"use strict";function f(f,g,h,i){c.getPayUrl(h,function(c,h){function j(c){function l(a){return a instanceof b.UnknownMessageOrigin?void 0:(k&&clearInterval(k),d.window.removeEventListener("message",j),g?f.close():d.log.info("payment window should be closed but client is managing it"),a?i(a):void i())}a.acceptPayMessage(c,e.getUrlOrigin(h),f,l)}if(c)return i(c);f.location=h;var k=setInterval(function(){return!f||f.closed?(clearInterval(k),i(b.PayWindowClosedByUser("polling detected a closed window"))):void 0},500);d.window.addEventListener("message",j)})}var g;a.processPayment=function(a,c,g){if(g=e.defaults(g,{managePaymentWindow:!0,paymentWindow:void 0}),!d.mozPay)return g.paymentWindow?(d.log.info("processing payment with web flow"),f(g.paymentWindow,g.managePaymentWindow,a,c)):c(b.IncorrectUsage("Cannot start a web payment without a reference to the payment window"));d.log.info("processing payment with mozPay using jwt",a);var h=d.mozPay([a]);h.onerror=function(){d.log.error("mozPay: received onerror():",this.error.name),d.onBrokenWebRT&&"USER_CANCELLED"===this.error.name?(d.log.warn("webRT: pretending the cancel message is actually a success!"),c()):c(b.PayPlatformError("mozPay error: "+this.error.name,{code:this.error.name}))},h.onsuccess=function(){d.log.debug("mozPay: received onsuccess()"),c()}},a.acceptPayMessage=function(a,c,e,f){if(d.log.debug("received",a.data,"from",a.origin),a.origin!==c)return f(b.UnknownMessageOrigin("ignoring message from foreign window at "+a.origin));var h=a.data||{};return"unloaded"!==h.status?"ok"===h.status?(d.log.info("received pay success message from window at",a.origin),f()):f("failed"===h.status?b.FailedWindowMessage("received pay fail message with status="+h.status+", code="+h.errorCode+" from window at "+a.origin,{code:h.errorCode}):b.FailedWindowMessage("received pay message with unknown status "+h.status+" from window at "+a.origin)):(g&&window.clearTimeout(g),void(g=window.setTimeout(function(){return e&&e.closed!==!0?void 0:f(b.PayWindowClosedByUser("Window closed by user"))},300)))}}),c("fxpay",["exports","errors","promise","pay","receipts","products","settings","utils"],function(a,b,c,d,e,f,g,h){"use strict";function i(a,c,d){d=d||{},d.maxTries=d.maxTries||10,d.pollIntervalMs=d.pollIntervalMs||1e3,d._tries=d._tries||1;var e=g.log;return e.debug("Getting transaction state for",a,"tries=",d._tries),d._tries>d.maxTries?(e.error("Giving up on transaction for",a,"after",d._tries,"tries"),c(b.PurchaseTimeout("timeout while waiting for completed transaction"))):void g.adapter.transactionStatus(a,function(b,f,g){return b?c(b):f?c(null,g):(e.debug("Re-trying incomplete transaction in",d.pollIntervalMs,"ms"),void window.setTimeout(function(){i(a,c,{maxTries:d.maxTries,pollIntervalMs:d.pollIntervalMs,_tries:d._tries+1})},d.pollIntervalMs))})}var j=c.Promise;a.errors=b,a.settings=g,a.configure=function(){return g.configure.apply(g,arguments)},a.init=function(b){g.initialize(b),h.logDeprecation("fxpay.init() is no longer supported; use fxpay.getProducts()...product.validateReceipt() instead","0.0.15"),a.getProducts().then(function(a){a.forEach(function(a){a.hasReceipt()&&a.validateReceipt().then(function(a){g.onrestore(null,a)}).catch(function(a){g.onrestore(a,a.productInfo)})})}).then(g.oninit).catch(g.onerror)},a.validateAppReceipt=function(){return g.initialize(),new j(function(a,c){h.getAppSelf(function(d,f){if(d)return c(d);
if(!f)return c(b.PayPlatformUnavailable("mozApps.getSelf() required for receipts"));var h=[];e.all(function(d,f){if(d)return c(d);f.forEach(function(a){var b=e.checkStoreData(a);return b?b.inapp_id?void g.log.info("ignoring in-app receipt with storedata",b):void h.push(a):void g.log.info("ignoring receipt with missing or unparsable storedata")}),g.log.info("app receipts found:",h.length);var i;return 0===h.length?c(b.AppReceiptMissing("no receipt found in getSelf()")):1===h.length?(i=h[0],g.log.info("Installed receipt:",i),e.validateAppReceipt(i,function(b,d){g.log.info("got verification result for",d),b?(b.productInfo=d,c(b)):a(d)})):c(b.NotImplementedError("multiple app receipts were found which is not yet supported"))})})})},a.purchase=function(a){g.initialize();var b,c;"function"==typeof arguments[1]?(b=arguments[1],c=arguments[2]):c=arguments[1],c=h.defaults(c,{maxTries:void 0,managePaymentWindow:void 0,paymentWindow:void 0,pollIntervalMs:void 0}),g.initialize();var e=new j(function(b,e){function j(){c.paymentWindow&&!c.paymentWindow.closed&&(c.managePaymentWindow?c.paymentWindow.close():g.log.info("payment window should be closed but client is managing it"))}"undefined"==typeof c.managePaymentWindow&&(c.managePaymentWindow=!c.paymentWindow);var k=new f.Product({productId:a});g.log.debug("starting purchase for product",a),g.mozPay||(c.paymentWindow?(g.log.info("web flow will use client provided payment window"),h.reCenterWindow(c.paymentWindow,g.winWidth,g.winHeight)):c.paymentWindow=h.openWindow()),g.adapter.startTransaction({productId:a},function(a,f){return a?(j(),a.productInfo=k,e(a)):void d.processPayment(f.productJWT,function(a){return a?(j(),a.productInfo=k,e(a)):void i(f,function(a,c){a?(a.productInfo=k,e(a)):b(c)},{maxTries:c.maxTries,pollIntervalMs:c.pollIntervalMs})},{managePaymentWindow:c.managePaymentWindow,paymentWindow:c.paymentWindow})})});return b&&(h.logDeprecation("purchase(id, callback) is no longer supported; use the returned promise instead","0.0.15"),e.then(function(a){b(null,a)}).catch(function(a){b(a,a.productInfo||new f.Product)})),e},a.getProduct=function(){return g.initialize(),f.get.apply(f,arguments)},a.getProducts=function(){return g.initialize(),f.all.apply(f,arguments)}}),b("fxpay")});
//# sourceMappingURL=fxpay.min.js.map