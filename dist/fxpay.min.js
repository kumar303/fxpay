!function(){"use strict";"undefined"==typeof window.fxpay&&(window.fxpay={});var a=window.fxpay;a.getattr=function(a){for(var b=a.split("."),c=window.fxpay,d="",e=0;e<b.length;e++){if(d&&(d+="."),d+=b[e],!c.hasOwnProperty(b[e]))throw new Error('The module "'+a+'" is not defined on fxpay. First undefined part: "'+d+'"');c=c[b[e]]}return c}}(),function(){"use strict";var a=fxpay.utils={};a.defaults=function(a,b){return a=a||{},Object.keys(b).forEach(function(c){"undefined"==typeof a[c]&&(a[c]=b[c])}),a},a.getSelfOrigin=function(a){if(a||(a=fxpay.getattr("settings")),a.appSelf){if(!a.appSelf.origin)throw new Error("app does not have an origin");return a.appSelf.origin}var b=a.window;return b.location.origin?b.location.origin:b.location.protocol+"//"+b.location.hostname},a.getUrlOrigin=function(a){var b=document.createElement("a");return b.href=a,b.origin||b.protocol+"//"+b.host},a.getCenteredCoordinates=function(a,b){var c=window.screenX+Math.max(0,Math.floor((window.innerWidth-a)/2)),d=window.screenY+Math.max(0,Math.floor((window.innerHeight-b)/2));return[c,d]},a.reCenterWindow=function(b,c,d){var e=fxpay.getattr("settings");c=c||e.winWidth,d=d||e.winHeight;var f=a.getCenteredCoordinates(c,d);try{b.resizeTo(c,d),b.moveTo(f[0],f[1])}catch(g){e.log.log("We don't have permission to resize this window")}},a.openWindow=function(b){var c=fxpay.getattr("settings"),d={url:"",title:"FxPay",w:c.winWidth,h:c.winHeight};b=a.defaults(b,d);var e=a.getCenteredCoordinates(b.w,b.h),f="toolbar=no,location=no,directories=no,menubar=no,scrollbars=yes,resizable=no,copyhistory=no,width="+b.w+",height="+b.h+",top="+e[1]+",left="+e[0],g=c.window.open(b.url,b.title,f);return g||c.log.error("window.open() failed. URL:",b.url),g}}(),function(){"use strict";var a=fxpay.settings={},b={version:"0.0.9"},c={allowAnyAppReceipt:!1,apiUrlBase:"https://marketplace.firefox.com",apiVersionPrefix:"/api/v1",apiTimeoutMs:null,extraProviderUrls:null,fakeProducts:!1,log:window.console||{debug:function(){},error:function(){},info:function(){},log:function(){},warn:function(){}},receiptCheckSites:["https://receiptcheck.marketplace.firefox.com","https://marketplace.firefox.com"],adapter:null,appSelf:null,hasAddReceipt:null,payProviderUrls:{"mozilla/payments/pay/v1":"https://marketplace.firefox.com/mozpay/?req={jwt}"},window:window,winWidth:276,winHeight:384,prepareJwtApiUrl:"/webpay/inapp/prepare/",onerror:function(a){throw a},oninit:function(){a.log.info("fxpay version:",a.libVersion),a.log.info("initialization ran successfully")},onrestore:function(b,c){b?a.log.error("error while restoring product:",c.productId,"message:",b):a.log.info("product",c.productId,"was restored from receipt")},initError:"NOT_INITIALIZED",localStorage:window.localStorage||null,localStorageKey:"fxpayReceipts",mozPay:navigator.mozPay||null,mozApps:navigator.mozApps||null,libVersion:b.version};a.configure=function(b,d){if(d=d||{},d.reset)for(var e in c)a[e]=c[e];for(var f in b){if("undefined"==typeof a[f])return a.log.error("configure() received an unknown setting:",f),a.onerror("INCORRECT_USAGE");a[f]=b[f]}if(a.extraProviderUrls){a.log.info("adding extra pay provider URLs",a.extraProviderUrls);for(var g in a.extraProviderUrls)a.payProviderUrls[g]=a.extraProviderUrls[g]}var h=fxpay.getattr("adapter").FxInappAdapter;return a.adapter?a.log.info("using custom adapter"):(a.log.info("using default adapter"),a.adapter=new h),a}}(),function(){"use strict";function a(a,b){b=b||{},this.baseUrl=a,this.log=d.log,this.timeoutMs=d.apiTimeoutMs||1e4,this.versionPrefix=d.apiVersionPrefix||void 0}function b(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}var c=fxpay.api={},d=fxpay.getattr("settings");c.API=a,a.prototype.url=function(a,b){b=b||{},b.versioned="undefined"!=typeof b.versioned?b.versioned:!0;var c=this.baseUrl;return b.versioned&&(c+=this.versionPrefix||""),c+=a},a.prototype.request=function(a,c,e,f,g){g=g||{};var h=e?"application/x-www-form-urlencoded":null;g.contentType=g.contentType||h;var i={Accept:"application/json"};g.contentType&&(i["Content-Type"]=g.contentType),g.headers=g.headers||{};for(var j in i)j in g.headers||(g.headers[j]=i[j]);g.headers["x-fxpay-version"]=d.libVersion;var k,l=this.log,m=this;f||(f=function(a,b){if(a)throw a;l.info("default callback received data:",b)}),k=/^http(s)?:\/\/.*/.test(c)?c:this.url(c);var n=new XMLHttpRequest({mozSystem:!0}),o={abort:function(){l.error("xhr abort: path:",c),f("API_REQUEST_ABORTED")},error:function(a){l.error("xhr error: ",a,"path:",c),f("API_REQUEST_ERROR")},load:function(){var a;if("2"!==this.status.toString().slice(0,1)){var b="BAD_API_RESPONSE";return l.error(b,"status:",this.status,"for URL:",k),l.debug(b,"response:",this.responseText),f("BAD_API_RESPONSE")}l.debug("xhr load: GOT",this.responseText);try{a=JSON.parse(this.responseText)}catch(c){var b="BAD_JSON_RESPONSE";return l.error(b,"for URL:",k,"exception",c,"response:",this.responseText),f(b)}f(null,a)},timeout:function(){l.error("xhr request to",k,"timed out after",m.timeoutMs,"ms"),f("API_REQUEST_TIMEOUT")}};for(var p in o)n.addEventListener(p,o[p],!1);l.debug("opening",a,"to",k),n.open(a,k,!0),n.timeout=m.timeoutMs;for(var q in g.headers)n.setRequestHeader(q,g.headers[q]);"application/x-www-form-urlencoded"===g.contentType&&e&&(e=b(e)),n.send(e)},a.prototype.get=function(a,b,c){this.request("GET",a,null,b,c)},a.prototype.del=function(a,b,c){this.request("DELETE",a,null,b,c)},a.prototype.post=function(a,b,c,d){this.request("POST",a,b,c,d)},a.prototype.put=function(a,b,c,d){this.request("PUT",a,b,c,d)}}(),function(){"use strict";var a=fxpay.jwt={},b=fxpay.getattr("settings");a.decode=function(a,c){var d=a.split(".");if(3!==d.length)return b.log.error("JWT does not have 3 segments:",a),c("WRONG_JWT_SEGMENT_COUNT");var e=d[1];e=e.replace("-","+","g").replace("_","/","g");var f;try{f=atob(e)}catch(g){return b.log.error("atob() error:",g.toString(),"when decoding JWT",e),c("INVALID_JWT_DATA")}var h;try{h=JSON.parse(f)}catch(g){return b.log.error("JSON.parse() error:",g.toString(),"when parsing",f),c("INVALID_JWT_DATA")}c(null,h)},a.getPayUrl=function(c,d){a.decode(c,function(a,e){if(a)return d(a);var f=b.payProviderUrls[e.typ];return f?-1===f.indexOf("{jwt}")?(b.log.error("JWT type",e.typ,"pay URL is formatted incorrectly:",f),d("INVALID_PAY_PROVIDER_URL")):(f=f.replace("{jwt}",c),b.log.info("JWT",e.typ,"resulted in pay URL:",f),void d(null,f)):(b.log.error("JWT type",e.typ,"does not map to any known payment providers"),d("UNEXPECTED_JWT_TYPE"))})}}(),function(){"use strict";function a(a,b,g,h){d.getPayUrl(g,function(d,g){function i(d){function j(c){return"UNKNOWN_MESSAGE_ORIGIN"!==c?(e.window.removeEventListener("message",i),b?a.close():e.log.info("payment window should be closed but client is managing it"),c?h(c):void h()):void 0}c.acceptPayMessage(d,f.getUrlOrigin(g),a,j)}return d?h(d):(a.location=g,void e.window.addEventListener("message",i))})}var b,c=fxpay.pay={},d=fxpay.getattr("jwt"),e=fxpay.getattr("settings"),f=fxpay.getattr("utils");c.processPayment=function(b,c,d){if(d=f.defaults(d,{managePaymentWindow:!0,paymentWindow:void 0}),!e.mozPay)return d.paymentWindow?(e.log.info("processing payment with web flow"),a(d.paymentWindow,d.managePaymentWindow,b,c)):(e.log.error("Cannot start a web payment without a reference to the payment window"),c("MISSING_PAYMENT_WINDOW"));e.log.info("processing payment with mozPay using jwt",b);var g=e.mozPay([b]);g.onerror=function(){e.log.error("mozPay: received onerror():",this.error.name),c(this.error.name)},g.onsuccess=function(){e.log.debug("mozPay: received onsuccess()"),c()}},c.acceptPayMessage=function(a,c,d,f){if(e.log.debug("received",a.data,"from",a.origin),a.origin!==c)return e.log.debug("ignoring message from foreign window at",a.origin),f("UNKNOWN_MESSAGE_ORIGIN");var g=a.data||{};return"unloaded"!==g.status?"ok"===g.status?(e.log.info("received pay success message from window at",a.origin),f()):"failed"===g.status?(e.log.info("received pay fail message with status",g.status,"code",g.errorCode,"from window at",a.origin),f(g.errorCode||"PAY_WINDOW_FAIL_MESSAGE")):(e.log.info("received pay message with unknown status",g.status,"from window at",a.origin),f("UNKNOWN_MESSAGE_STATUS")):(b&&window.clearTimeout(b),void(b=window.setTimeout(function(){return d&&d.closed!==!0?void 0:(e.log.info("Window closed by user."),f("DIALOG_CLOSED_BY_USER"))},300)))}}(),function(){"use strict";function a(a){return{productId:a.guid,name:a.name,smallImageUrl:a.logo_url}}var b=fxpay.products={},c=fxpay.getattr("settings"),d=fxpay.getattr("utils"),e=fxpay.getattr("api").API;b.all=function(b){var f=[];if(c.initError)return c.log.error("init failed:",c.initError),b(c.initError,f);var g=new e(c.apiUrlBase),h=d.getSelfOrigin();if(!h)return b("PAY_PLATFORM_UNAVAILABLE",f);h=encodeURIComponent(h);var i;c.fakeProducts?(c.log.warn("about to fetch fake products"),i="/payments/stub-in-app-products/"):(c.log.info("about to fetch real products for app",h),i="/payments/"+h+"/in-app/?active=1"),g.get(i,function(d,e){if(d)return b(d,f);c.log.info("total products fetched:",e.objects.length);for(var g=0;g<e.objects.length;g++){var h=e.objects[g],i=a(h);f.push(i)}b(d,f)})},b.getById=function(b,f,g){g=g||{},"undefined"==typeof g.fetchStubs&&(g.fetchStubs=!1),g.api||(g.api=new e(c.apiUrlBase));var h,i=encodeURIComponent(d.getSelfOrigin());h=g.fetchStubs?"/payments/stub-in-app-products/"+b.toString()+"/":"/payments/"+i+"/in-app/"+b.toString()+"/",c.log.info("fetching product info at URL",h,"fetching stubs?",g.fetchStubs),g.api.get(h,function(d,e){return d?(c.log.error("Error fetching product info",d),f(d,{productId:b})):void f(null,a(e))})}}(),function(){"use strict";function a(a,b){var c=j.appSelf.addReceipt(a);c.onsuccess=function(){j.log.info("item fully purchased and receipt installed"),b(null)},c.onerror=function(){var a=this.error.name;j.log.error("error calling app.addReceipt",a),b(a)}}function b(a,b){var c=j.localStorage.getItem(j.localStorageKey);c=c?JSON.parse(c):[],-1===c.indexOf(a)?c.push(a):j.log.info("not adding receipt",a.substring(0,5),"because it has already been added"),j.localStorage.setItem(j.localStorageKey,JSON.stringify(c)),b(null)}function c(a,b){var c={};if("string"!=typeof a)return j.log.error("unexpected receipt type:",typeof a),b("INVALID_RECEIPT",c);var d=a.split("~");if(1===d.length)c=d[0];else{if(2!==d.length)return j.log.error("wrong number of tilde separated segments in receipt"),b("INVALID_RECEIPT",c);c=d[1]}var e=c.split(".");if(3!==e.length)return j.log.error("wrong number of JWT segments in receipt:",e.length),b("INVALID_RECEIPT",c);c=e[1];try{c=f(c)}catch(g){return j.log.error("error base64 decoding receipt:",g.name,g.message),b("INVALID_RECEIPT",c)}try{c=JSON.parse(c)}catch(g){return j.log.error("error parsing receipt JSON:",g.name,g.message),b("INVALID_RECEIPT",c)}return b(null,c)}function d(a,b){var c={};if(!a.product)return j.log.error("receipt is missing the product field"),b("INVALID_RECEIPT",c);if(!a.product.url)return j.log.error("receipt is missing product.url"),b("INVALID_RECEIPT",c);if(!a.product.storedata)return j.log.error("receipt is missing product.storedata"),b("INVALID_RECEIPT",c);if("string"!=typeof a.product.storedata)return j.log.error("unexpected storedata in receipt:",a.product.storedata),b("INVALID_RECEIPT",c);var d={};if(a.product.storedata.split("&").forEach(function(a){var b=a.split("=");d[b[0]]=decodeURIComponent(b[1])}),c.productId=d.inapp_id,!c.productId)return j.log.error("Could not find productId in storedata:",a.product.storedata),b("INVALID_RECEIPT",c);var e=a.product.url;e&&!e.match(/^(http(s)?|app):\/\/.*$/g)&&(e="app://"+e),c.productUrl=e;var f="test-receipt"===a.typ;if(f&&!j.fakeProducts)return j.log.error("cannot restore test receipts when fakeProducts is false"),b("TEST_RECEIPT_NOT_ALLOWED",c);var g=j.fakeProducts&&f;if(!j.allowAnyAppReceipt&&!g){var h=k.getSelfOrigin();if(e!==h)return j.log.error("app origin",h,"does not match receipt product URL",e),b("INVALID_RECEIPT",c)}b(null,c)}function e(a,b){for(var c=!1,d=a.verify||"",e=0;e<j.receiptCheckSites.length;e++){var f=j.receiptCheckSites[e];if(0===d.indexOf(f)){c=!0;break}}return c?void b(null,a):(j.log.error("Receipt check URL",a.verify,"is not whitelisted. Valid choices:",j.receiptCheckSites),b("INVALID_RECEIPT",a))}function f(a){switch(a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),a.length%4){case 0:break;case 1:a+="===";break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}return atob(a)}var g=fxpay.receipts={},h=fxpay.getattr("api").API,i=fxpay.getattr("products"),j=fxpay.getattr("settings"),k=fxpay.getattr("utils");g.all=function(){var a=0,b=[];j.appSelf&&j.appSelf.receipts&&(a=j.appSelf.receipts.length,b=Array.prototype.slice.call(j.appSelf.receipts));var c=0,d=j.localStorage.getItem(j.localStorageKey);if(d){d=JSON.parse(d);for(var e=0;e<d.length;e++)-1===b.indexOf(d[e])?(b.push(d[e]),c++):j.log.info("ignoring dupe receipt fetched from local storage",d[e].substring(0,5))}return j.log.info("receipts fetched from mozApps:",a),j.log.info("receipts fetched from localStorage:",c),b},g.add=function(c,d){return j.hasAddReceipt?(j.log.info("adding receipt to device with addReceipt"),a(c,d)):(j.log.info("adding receipt to device with localStorage"),b(c,d))},g.verify=function(a,b){g.verifyData(a,function(c,d,e){if(c)return b(c,e);j.log.debug("receipt data:",d);var f=d.iss;j.log.info("derived base API URL from receipt:",f);var g=new h(f);j.log.info("about to post to verifier URL",d.verify),g.post(d.verify,a,function(c,f){return c?(j.log.error("Error verifying receipt:",c),b(c,e)):(j.log.info("verification result:",f),"ok"!==f.status?(j.log.error("receipt",a.substring(0,10),"is invalid; service returned:",f.status,f.reason),b("INVALID_RECEIPT",e)):(j.log.info("validated receipt for",e),void i.getById(e.productId,function(a,c){return a?b(a,e):b(null,c)},{fetchStubs:"test-receipt"===d.typ,api:g})))},{contentType:"text/plain"})})},g.verifyData=function(a,b){c(a,function(a,c){return a?b(a,c,{}):void d(c,function(a,d){return a?b(a,c,d):void e(c,function(a){return a?b(a,c,d):void b(null,c,d)})})})}}(),function(){"use strict";function a(){f.log.info("using Firefox Marketplace In-App adapter"),this.api=new c(f.apiUrlBase)}var b=fxpay.adapter={},c=fxpay.getattr("api").API,d=fxpay.getattr("products"),e=fxpay.getattr("receipts"),f=fxpay.getattr("settings"),g=fxpay.getattr("utils");a.prototype.init=function(a){if(!f.hasAddReceipt&&!f.localStorage)return f.log.error("no way to store receipts on this platform"),a("PAY_PLATFORM_UNAVAILABLE");if(f.appSelf&&0===f.window.location.href.indexOf("app://")&&!f.appSelf.manifest.origin)return f.log.error("packaged app did not define an origin so we have no key to look up products"),a("UNDEFINED_APP_ORIGIN");for(var b,c=0,d=e.all(),g=0;g<d.length;g++)b=d[g],f.log.info("Installed receipt: "+b),c++,e.verify(b,f.onrestore);f.log.info("Number of receipts installed: "+c),a()},a.prototype.startTransaction=function(a,b){a=g.defaults(a,{productId:null});var c=this;c.api.post(f.prepareJwtApiUrl,{inapp:a.productId},function(c,d){return c?b(c):(f.log.debug("requested JWT for ",a.productId,"from API; got:",d),b(null,{productJWT:d.webpayJWT,productId:a.productId,productData:d}))})},a.prototype.transactionStatus=function(a,b){var c=this,d=c.api.url(a.productData.contribStatusURL,{versioned:!1});c.api.get(d,function(e,g){return e?b(e):"complete"!==g.status?"incomplete"===g.status?b(null,!1):(f.log.error("transaction status",g.status,"from",d,"was unexpected"),b("INVALID_TRANSACTION_STATE")):void c._finishTransaction(g,a.productId,function(a,c){return a?b(a):void b(null,!0,c)})})},a.prototype._finishTransaction=function(a,b,c){f.log.info("received completed transaction:",a),e.add(a.receipt,function(a){return a?c(a):void d.getById(b,function(a,b){return a?c(a,b):void c(null,b)},{fetchStubs:f.fakeProducts})})},b.FxInappAdapter=a}(),function(){"use strict";function a(a){if(!e.mozApps)return e.log.info("web platform does not define mozApps, cannot get appSelf"),a(null,null);var b=e.mozApps.getSelf();b.onsuccess=function(){a(null,this.result)},b.onerror=function(){var b=this.error.name;e.log.error("mozApps.getSelf() returned an error",b),a(b)}}function b(a,c,d){d=d||{},d.maxTries=d.maxTries||10,d.pollIntervalMs=d.pollIntervalMs||1e3,d._tries=d._tries||1;var f=e.log;return f.debug("Getting transaction state for",a,"tries=",d._tries),d._tries>d.maxTries?(f.error("Giving up on transaction for",a,"after",d._tries,"tries"),c("TRANSACTION_TIMEOUT")):void e.adapter.transactionStatus(a,function(e,g,h){return e?c(e):g?c(null,h):(f.debug("Re-trying incomplete transaction in",d.pollIntervalMs,"ms"),void window.setTimeout(function(){b(a,c,{maxTries:d.maxTries,pollIntervalMs:d.pollIntervalMs,_tries:d._tries+1})},d.pollIntervalMs))})}var c=window.fxpay,d=fxpay.getattr("pay"),e=fxpay.getattr("settings"),f=fxpay.getattr("products"),g=fxpay.getattr("utils");c.configure=function(){return e.configure.apply(e,arguments)},c.configure({},{reset:!0}),c.init=function(b){function d(a){return e.initError=a,e.onerror(e.initError)}b=b||{},c.configure(b),a(function(a,b){return a?d(a):(e.appSelf=b,e.hasAddReceipt=e.appSelf&&e.appSelf.addReceipt,void e.adapter.init(function(a){return a?d(a):(e.initError=null,void e.oninit())}))})},c.purchase=function(a,c,f){function h(){f.paymentWindow&&!f.paymentWindow.closed&&(f.managePaymentWindow?f.paymentWindow.close():e.log.info("payment window should be closed but client is managing it"))}f=g.defaults(f,{maxTries:void 0,managePaymentWindow:void 0,paymentWindow:void 0,pollIntervalMs:void 0}),"undefined"==typeof f.managePaymentWindow&&(f.managePaymentWindow=!f.paymentWindow);var i={productId:a};return c||(c=function(a,b){if(a)throw a;e.log.info("product",b.productId,"purchased")}),e.initError?(e.log.error("init failed:",e.initError),c(e.initError,i)):(e.log.debug("starting purchase for product",a),e.mozPay||(f.paymentWindow?(e.log.info("web flow will use client provided payment window"),g.reCenterWindow(f.paymentWindow,e.winWidth,e.winHeight)):f.paymentWindow=g.openWindow()),void e.adapter.startTransaction({productId:a},function(a,e){return a?(h(),c(a,i)):void d.processPayment(e.productJWT,function(a){return a?(h(),c(a,i)):void b(e,function(a,b){c(a,b||i)},{maxTries:f.maxTries,pollIntervalMs:f.pollIntervalMs})},{managePaymentWindow:f.managePaymentWindow,paymentWindow:f.paymentWindow})}))},c.getProducts=function(){f.all.apply(f,arguments)}}();
//# sourceMappingURL=fxpay.min.js.map